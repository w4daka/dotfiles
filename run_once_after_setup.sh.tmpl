#!/bin/bash
# ================================================================= #
# ğŸš€ çµ±åˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (Mise / Zsh / Flatpak / Neovim)
# ================================================================= #
set -euo pipefail

echo "--- ğŸ“¦ 1. ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ (apt) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---"
sudo apt update
sudo apt install -y \
    zsh i3 rofi make unzip gcc git curl flatpak fcitx5 \
    libxkbcommon0 libc6 build-essential pkg-config libssl-dev

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™
mkdir -p "$HOME/.local/bin"
export PATH="$HOME/.local/bin:$PATH"

echo "--- ğŸ’¤ 2. Neovim (AppImage) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---"
curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.appimage
chmod u+x nvim-linux-x86_64.appimage
mv nvim-linux-x86_64.appimage "$HOME/.local/bin/nvim"

echo "--- ğŸš 3. Sheldon ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---"
curl --proto '=https' -fLsS https://rossmacarthur.github.io/install/crate.sh \
    | bash -s -- --repo rossmacarthur/sheldon --to ~/.local/bin

echo "--- âœ¨ 4. Starship ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---"
curl -sS https://starship.rs/install.sh | sh -s -- --yes --bin-dir "$HOME/.local/bin"

echo "--- ğŸŒ 5. Flatpak ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---"
sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
flatpak install -y flathub com.google.Chrome org.mozilla.firefox net.ankiweb.Anki

echo "--- ğŸ› ï¸ 6. mise ã®å°å…¥ã¨ãƒ„ãƒ¼ãƒ«ä¸€æ‹¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---"
# æ¨å¥¨ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨
curl https://mise.run/bash | sh

# ç¾åœ¨ã®ã‚·ã‚§ãƒ«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ mise ã‚’æœ‰åŠ¹åŒ–
export PATH="$HOME/.local/bin:$HOME/.local/share/mise/bin:$PATH"
eval "$(mise activate bash)"

# mise.toml (chezmoiã§é…ç½®æ¸ˆã¿æƒ³å®š) ã«åŸºã¥ããƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
mise install -y

echo "--- ğŸ“¦ 7. Node.js ãƒ„ãƒ¼ãƒ« (Typescript, yarn) ---"
npm install -g typescript yarn

echo "--- 8. Nerd Fonts (JetBrainsMono) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---"
# ãƒ•ã‚©ãƒ³ãƒˆä¿å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
mkdir -p ~/.local/share/fonts

# JetBrainsMono Nerd Font ã®æœ€æ–°ç‰ˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
# (v3.1.0ä»¥é™ã€GitHubã®æ§‹é€ ãŒå¤‰ã‚ã£ãŸãŸã‚ç›´æ¥ã‚¿ã‚°æŒ‡å®šã‹æœ€æ–°ãƒã‚¤ãƒŠãƒªã‚’ç‹™ã„ã¾ã™)
FONT_NAME="JetBrainsMono"
URL="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/${FONT_NAME}.zip"

echo "Downloading ${FONT_NAME} Nerd Font..."
curl -fLo "/tmp/${FONT_NAME}.zip" "$URL"

# è§£å‡ã—ã¦ãƒ•ã‚©ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ç§»å‹•
unzip -o "/tmp/${FONT_NAME}.zip" -d ~/.local/share/fonts/${FONT_NAME}

# ãƒ•ã‚©ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ›´æ–°
fc-cache -fv

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
rm "/tmp/${FONT_NAME}.zip"

echo "âœ… ãƒ•ã‚©ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"

echo "--- ğŸ”„ 9. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ã‚§ãƒ«ã‚’ Zsh ã¸å¤‰æ›´ ---"
if [ "$SHELL" != "$(which zsh)" ]; then
    sudo chsh -s "$(which zsh)" "$USER"
fi

echo "âœ… ã™ã¹ã¦ã®å·¥ç¨‹ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo "å†èµ·å‹•å¾Œã€zsh ä¸Šã§ 'mise -v' ã‚„ 'nvim' ãŒå‹•ãã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
