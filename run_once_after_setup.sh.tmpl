#!/bin/bash
# ================================================================= #
# ğŸš€ Universal Setup Script (Ubuntu & EndeavourOS / Arch)
# ================================================================= #
set -euo pipefail

# --- ğŸ” OSåˆ¤åˆ¥é–¢æ•°ã®å®šç¾© ---
if [ -f /etc/arch-release ]; then
    OS="arch"
    INSTALL_CMD="sudo pacman -S --noconfirm --needed"
    UPDATE_CMD="sudo pacman -Syu --noconfirm"
    PKG_LIST="base-devel zsh i3-wm rofi make unzip gcc git curl flatpak fcitx5-im libxkbcommon glibc pkgconf openssl fontconfig"
elif [ -f /etc/lsb-release ] || [ -f /etc/debian_version ]; then
    OS="debian"
    INSTALL_CMD="sudo apt install -y"
    UPDATE_CMD="sudo apt update"
    PKG_LIST="zsh i3 rofi make unzip gcc git curl flatpak fcitx5 libxkbcommon0 libc6 build-essential pkg-config libssl-dev fontconfig"
else
    echo "âŒ ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„OSã§ã™ã€‚"
    exit 1
fi

echo "--- ğŸ“¦ 1. ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ ($OS) ---"
$UPDATE_CMD
$INSTALL_CMD $PKG_LIST

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™
mkdir -p "$HOME/.local/bin"
mkdir -p "$HOME/.local/share/fonts"
export PATH="$HOME/.local/bin:$PATH"

echo "--- font 2. Nerd Fonts (JetBrainsMono) ---"
FONT_URL="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip"
curl -fLo "/tmp/JetBrainsMono.zip" "$FONT_URL"
unzip -o "/tmp/JetBrainsMono.zip" -d "$HOME/.local/share/fonts/"
fc-cache -f

echo "--- ğŸ’¤ 3. Neovim ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---"
if [ "$OS" = "arch" ]; then
    sudo pacman -S --noconfirm neovim
else
    # Ubuntuã®å ´åˆã¯æœ€æ–°ç‰ˆã‚’ç¢ºä¿ã™ã‚‹ãŸã‚AppImageã‚’ä½¿ç”¨
    curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.appimage
    chmod u+x nvim-linux-x86_64.appimage
    mv nvim-linux-x86_64.appimage "$HOME/.local/bin/nvim"
fi

echo "--- ğŸš 4. Sheldon ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---"
curl --proto '=https' -fLsS https://rossmacarthur.github.io/install/crate.sh \
    | bash -s -- --repo rossmacarthur/sheldon --to ~/.local/bin

echo "--- âœ¨ 5. Starship ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---"
curl -sS https://starship.rs/install.sh | sh -s -- --yes --bin-dir "$HOME/.local/bin"

echo "--- ğŸŒ 6. Flatpak ãƒªãƒã‚¸ãƒˆãƒªè¨­å®š ---"
sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo

echo "--- ğŸ› ï¸  7. mise ã®å°å…¥ ---"
curl https://mise.run/bash | sh
export MISE_DATA_DIR="$HOME/.local/share/mise"
export PATH="$HOME/.local/bin:$MISE_DATA_DIR/bin:$MISE_DATA_DIR/shims:$PATH"
eval "$($HOME/.local/bin/mise activate bash)"

if [ -f "$HOME/.config/mise/config.toml" ]; then
    mise install -y
else
    echo "âš ï¸  mise config not found, skipping tool installation."
fi

echo "--- ğŸ“¦ 8. Node.js ãƒ„ãƒ¼ãƒ« ---"
# miseã§nodeãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè¡Œ
if command -v npm &> /dev/null; then
    npm install -g typescript yarn
fi

echo "--- ğŸ”„ 9. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ã‚§ãƒ«ã‚’ Zsh ã¸å¤‰æ›´ ---"
if [[ "$SHELL" != */zsh ]]; then
    sudo chsh -s "$(which zsh)" "$USER"
fi

echo "âœ… ã™ã¹ã¦å®Œäº†ï¼å†èµ·å‹•å¾Œã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’ 'JetBrainsMono Nerd Font' ã«ã—ã¦ãã ã•ã„ã€‚"
